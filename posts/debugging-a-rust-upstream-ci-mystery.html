<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
</head>
<body>
<div style="line-height: 150%; text-align: justify; margin-left: 10%; margin-right: 10%; margin-top: 0; margin-bottom: 0">
<h1>Debugging a Rust Upstream CI Mystery</h1>
<p>2023-06-10 15:17:12</p>
<hr />
<p>Recently I have been working on a <a href="https://github.com/rust-lang/rust/pull/111626">pull request</a> for Rust. After it was approved,
the CI jobs were automatically started by the bot (bors), to run a full set of tests.
One of the jobs, <code>dist-various-1</code>, failed, and I fixed it in my PR.
In order to make sure that the job can now pass, I manually ran
<code>dist-various-{1,2}</code>, following the instructions from the <a href="https://rustc-dev-guide.rust-lang.org/tests/ci.html#using-ci-to-test">official guide</a>.
This time both jobs failed with this error:</p>
<pre style="background-color:#eff1f5;"><code><span style="color:#4f5b66;">cp: cannot stat &#39;obj/build/metrics.json&#39;: No such file or directory
</span><span style="color:#4f5b66;">##[error]Process completed with exit code 1.
</span></code></pre>
<p>I was pretty sure that I never touched anything related to <code>metrics.json</code> or
to metrics in general. Actually I didn't even know what metrics mean in this context.
But at least my fix for the original problem seemed to work because this was a new error.</p>
<p>So, what is <code>metrics.json</code>? Where was that error from?
Searching for <code>metrics.json</code> in the codebase quickly showed that the error came from
the script <code>upload-artifacts.sh</code> that uploads the build artifacts to S3:</p>
<pre style="background-color:#eff1f5;"><code class="language-bash"><span style="color:#a7adba;">#!/bin/bash
</span><span style="color:#a7adba;"># Upload all the artifacts to our S3 bucket. All the files inside ${upload_dir}
</span><span style="color:#a7adba;"># will be uploaded to the deploy bucket and eventually signed and released in
</span><span style="color:#a7adba;"># static.rust-lang.org.
</span><span style="color:#a7adba;"># ...
</span><span style="color:#a7adba;"># Build metrics generated by x.py.
</span><span style="color:#8fa1b3;">cp </span><span style="color:#4f5b66;">&quot;$</span><span style="color:#a3be8c;">{</span><span style="color:#bf616a;">build_dir</span><span style="color:#a3be8c;">}/metrics.json</span><span style="color:#4f5b66;">&quot; &quot;$</span><span style="color:#a3be8c;">{</span><span style="color:#bf616a;">upload_dir</span><span style="color:#a3be8c;">}/metrics-</span><span style="color:#4f5b66;">$</span><span style="color:#a3be8c;">{</span><span style="color:#bf616a;">CI_JOB_NAME</span><span style="color:#a3be8c;">}.json</span><span style="color:#4f5b66;">&quot;
</span><span style="color:#a7adba;"># ...
</span></code></pre>
<p>Luckily, this script answered my questions: <code>metrics.json</code> contains build metrics, which are collected
and displayed on <a href="https://static.rust-lang.org">static.rust-lang.org</a>. The error was because <code>metrics.json</code> was
somehow missing.</p>
<p>Why was it missing then? Continuing with the search for <code>metrics.json</code>,
it showed that this function is what generates that file:</p>
<pre style="background-color:#eff1f5;"><code class="language-rust"><span style="color:#b48ead;">impl </span><span style="color:#4f5b66;">BuildMetrics {
</span><span style="color:#4f5b66;">    </span><span style="color:#a7adba;">// ...
</span><span style="color:#4f5b66;">    </span><span style="color:#b48ead;">pub</span><span style="color:#4f5b66;">(</span><span style="color:#b48ead;">crate</span><span style="color:#4f5b66;">) </span><span style="color:#b48ead;">fn </span><span style="color:#8fa1b3;">persist</span><span style="color:#4f5b66;">(&amp;</span><span style="color:#bf616a;">self</span><span style="color:#4f5b66;">, </span><span style="color:#bf616a;">build</span><span style="color:#4f5b66;">: &amp;Build) {
</span><span style="color:#4f5b66;">        </span><span style="color:#a7adba;">// ...
</span><span style="color:#4f5b66;">        </span><span style="color:#b48ead;">let</span><span style="color:#4f5b66;"> dest = build.out.</span><span style="color:#96b5b4;">join</span><span style="color:#4f5b66;">(&quot;</span><span style="color:#a3be8c;">metrics.json</span><span style="color:#4f5b66;">&quot;);
</span><span style="color:#4f5b66;">        </span><span style="color:#a7adba;">// ...
</span><span style="color:#4f5b66;">        t!(std::fs::create_dir_all(dest.</span><span style="color:#96b5b4;">parent</span><span style="color:#4f5b66;">().</span><span style="color:#96b5b4;">unwrap</span><span style="color:#4f5b66;">()));
</span><span style="color:#4f5b66;">        </span><span style="color:#b48ead;">let mut</span><span style="color:#4f5b66;"> file = BufWriter::new(t!(File::create(&amp;dest)));
</span><span style="color:#4f5b66;">        t!(serde_json::to_writer(&amp;</span><span style="color:#b48ead;">mut</span><span style="color:#4f5b66;"> file, &amp;json));
</span><span style="color:#4f5b66;">    }
</span><span style="color:#4f5b66;">    </span><span style="color:#a7adba;">// ...
</span><span style="color:#4f5b66;">}
</span></code></pre>
<p>And it's called like:</p>
<pre style="background-color:#eff1f5;"><code class="language-rust"><span style="color:#b48ead;">impl </span><span style="color:#4f5b66;">Build {
</span><span style="color:#4f5b66;">    </span><span style="color:#a7adba;">// ...
</span><span style="color:#4f5b66;">    </span><span style="color:#a7adba;">/// Executes the entire build, as configured by the flags and configuration.
</span><span style="color:#4f5b66;">    </span><span style="color:#b48ead;">pub fn </span><span style="color:#8fa1b3;">build</span><span style="color:#4f5b66;">(&amp;</span><span style="color:#b48ead;">mut </span><span style="color:#bf616a;">self</span><span style="color:#4f5b66;">) {
</span><span style="color:#4f5b66;">        </span><span style="color:#a7adba;">// ...
</span><span style="color:#4f5b66;">        #[</span><span style="color:#bf616a;">cfg</span><span style="color:#4f5b66;">(feature = &quot;</span><span style="color:#a3be8c;">build-metrics</span><span style="color:#4f5b66;">&quot;)]
</span><span style="color:#4f5b66;">        </span><span style="color:#bf616a;">self</span><span style="color:#4f5b66;">.metrics.</span><span style="color:#96b5b4;">persist</span><span style="color:#4f5b66;">(</span><span style="color:#bf616a;">self</span><span style="color:#4f5b66;">);
</span><span style="color:#4f5b66;">    }
</span><span style="color:#4f5b66;">    </span><span style="color:#a7adba;">// ...
</span><span style="color:#4f5b66;">}
</span></code></pre>
<p>Note that the call is compiled only if the <code>build-metrics</code> feature is enabled.
So probably the feature wasn't enabled in the CI job?
Searching for <code>build-metrics</code> and excluding all the conditional compilation attributes
led me to these lines in <code>bootstrap.py</code>:</p>
<pre style="background-color:#eff1f5;"><code class="language-Python"><span style="color:#b48ead;">class </span><span style="color:#d08770;">RustBuild</span><span style="color:#343d46;">(</span><span style="color:#a3be8c;">object</span><span style="color:#343d46;">):
</span><span style="color:#4f5b66;">    </span><span style="color:#a7adba;"># ...
</span><span style="color:#4f5b66;">    </span><span style="color:#b48ead;">def </span><span style="color:#8fa1b3;">build_bootstrap</span><span style="color:#4f5b66;">(</span><span style="color:#bf616a;">self</span><span style="color:#4f5b66;">, </span><span style="color:#bf616a;">color</span><span style="color:#4f5b66;">, </span><span style="color:#bf616a;">warnings</span><span style="color:#4f5b66;">, </span><span style="color:#bf616a;">verbose_count</span><span style="color:#4f5b66;">):
</span><span style="color:#4f5b66;">        </span><span style="color:#a7adba;"># ...
</span><span style="color:#4f5b66;">        </span><span style="color:#b48ead;">if </span><span style="color:#bf616a;">self</span><span style="color:#4f5b66;">.</span><span style="color:#8fa1b3;">get_toml</span><span style="color:#4f5b66;">(&quot;</span><span style="color:#a3be8c;">metrics</span><span style="color:#4f5b66;">&quot;, &quot;</span><span style="color:#a3be8c;">build</span><span style="color:#4f5b66;">&quot;):
</span><span style="color:#4f5b66;">            args.</span><span style="color:#8fa1b3;">append</span><span style="color:#4f5b66;">(&quot;</span><span style="color:#a3be8c;">--features</span><span style="color:#4f5b66;">&quot;)
</span><span style="color:#4f5b66;">            args.</span><span style="color:#8fa1b3;">append</span><span style="color:#4f5b66;">(&quot;</span><span style="color:#a3be8c;">build-metrics</span><span style="color:#4f5b66;">&quot;)
</span><span style="color:#4f5b66;">        </span><span style="color:#a7adba;"># ...
</span><span style="color:#4f5b66;">    </span><span style="color:#a7adba;"># ...
</span></code></pre>
<p>This told me that the feature will be enabled if <code>metrics</code> is set to <code>true</code> in the <code>[build]</code> section of <code>config.toml</code>.
It also hinted that searching instead for regex <code>/build.metrics/</code> might be useful. Within the search result,
this if-branch from <code>src/ci/run.sh</code> caught my attention:</p>
<pre style="background-color:#eff1f5;"><code class="language-bash"><span style="color:#b48ead;">if </span><span style="color:#4f5b66;">! </span><span style="color:#8fa1b3;">isCI </span><span style="color:#4f5b66;">|| </span><span style="color:#8fa1b3;">isCiBranch</span><span style="color:#4f5b66;"> auto || </span><span style="color:#8fa1b3;">isCiBranch</span><span style="color:#4f5b66;"> beta || </span><span style="color:#8fa1b3;">isCiBranch</span><span style="color:#4f5b66;"> try || </span><span style="color:#8fa1b3;">isCiBranch</span><span style="color:#4f5b66;"> try-perf; </span><span style="color:#b48ead;">then
</span><span style="color:#4f5b66;">    </span><span style="color:#bf616a;">RUST_CONFIGURE_ARGS</span><span style="color:#4f5b66;">=&quot;$</span><span style="color:#bf616a;">RUST_CONFIGURE_ARGS</span><span style="color:#a3be8c;"> --set build.print-step-timings --enable-verbose-tests</span><span style="color:#4f5b66;">&quot;
</span><span style="color:#4f5b66;">    </span><span style="color:#bf616a;">RUST_CONFIGURE_ARGS</span><span style="color:#4f5b66;">=&quot;$</span><span style="color:#bf616a;">RUST_CONFIGURE_ARGS</span><span style="color:#a3be8c;"> --set build.metrics</span><span style="color:#4f5b66;">&quot;
</span><span style="color:#4f5b66;">    </span><span style="color:#bf616a;">HAS_METRICS</span><span style="color:#4f5b66;">=</span><span style="color:#a3be8c;">1
</span><span style="color:#b48ead;">fi
</span></code></pre>
<p>Clearly <code>--set build.metrics</code> is only specified if</p>
<ul>
<li>the build is not run with CI, or</li>
<li>the branch being built is <code>refs/heads/auto</code>, or</li>
<li>the branch being built is <code>refs/heads/beta</code>, or</li>
<li>the branch being built is <code>refs/heads/try</code>, or</li>
<li>the branch being built is <code>refs/heads/try-perf</code></li>
</ul>
<p>Unfortunately the failing job didn't satisfy any of these conditions because its environment included:</p>
<pre style="background-color:#eff1f5;"><code><span style="color:#4f5b66;">2023-06-05T02:37:02.9545370Z CI=true
</span><span style="color:#4f5b66;">2023-06-05T02:37:02.9552191Z GITHUB_REF=refs/pull/111626/merge
</span></code></pre>
<p>However the job triggered by bors has an environment including:</p>
<pre style="background-color:#eff1f5;"><code><span style="color:#4f5b66;">2023-06-02T22:35:24.2979000Z CI=true
</span><span style="color:#4f5b66;">2023-06-02T22:35:24.2990509Z GITHUB_REF=refs/heads/auto
</span></code></pre>
<p>Back to the beginning, why did the job that I manually launched fail? Because its environment didn't request the build to
produce <code>metrics.json</code> at all. But wait, every time a PR is opened or pushed to, several default jobs will run.
Why didn't these jobs fail? They shouldn't take the if-branch, because they were not launched by bors either.
I then checked the CI result of one of these jobs, <code>x86_64-gnu-llvm-14</code>, and found that the step of
uploading build artifacts to S3 was not executed. Looking at the definition of that step,
I saw the following <code>if</code> expression at the end:</p>
<pre style="background-color:#eff1f5;"><code class="language-yaml"><span style="color:#4f5b66;">      - </span><span style="color:#bf616a;">name</span><span style="color:#4f5b66;">: </span><span style="color:#a3be8c;">upload artifacts to S3
</span><span style="color:#4f5b66;">        </span><span style="color:#bf616a;">run</span><span style="color:#4f5b66;">: </span><span style="color:#a3be8c;">src/ci/scripts/upload-artifacts.sh
</span><span style="color:#4f5b66;">        </span><span style="color:#bf616a;">env</span><span style="color:#4f5b66;">:
</span><span style="color:#4f5b66;">          </span><span style="color:#bf616a;">AWS_ACCESS_KEY_ID</span><span style="color:#4f5b66;">: &quot;</span><span style="color:#a3be8c;">${{ env.ARTIFACTS_AWS_ACCESS_KEY_ID }}</span><span style="color:#4f5b66;">&quot;
</span><span style="color:#4f5b66;">          </span><span style="color:#bf616a;">AWS_SECRET_ACCESS_KEY</span><span style="color:#4f5b66;">: &quot;</span><span style="color:#a3be8c;">${{ secrets[format(&#39;AWS_SECRET_ACCESS_KEY_{0}&#39;, env.ARTIFACTS_AWS_ACCESS_KEY_ID)] }}</span><span style="color:#4f5b66;">&quot;
</span><span style="color:#4f5b66;">        </span><span style="color:#bf616a;">if</span><span style="color:#4f5b66;">: &quot;</span><span style="color:#a3be8c;">success() &amp;&amp; !env.SKIP_JOB &amp;&amp; (github.event_name == &#39;push&#39; || env.DEPLOY == &#39;1&#39; || env.DEPLOY_ALT == &#39;1&#39;)</span><span style="color:#4f5b66;">&quot;
</span></code></pre>
<p>That says, the uploading step is only executed when</p>
<ul>
<li>all the previous steps have succeeded, and</li>
<li><code>SKIP_JOB</code> is not defined in the environment, and</li>
<li>either
<ul>
<li>the triggering event is push, or</li>
<li><code>DEPLOY</code> is set to 1, or</li>
<li><code>DEPLOY_ALT</code> is set to 1</li>
</ul>
</li>
</ul>
<p>In my case, only the last three OR-ed conditions would make a difference. Comparing the environment of <code>x86_64-gnu-llvm-14</code>
to that of <code>dist-various-1</code> indicated that the latter had <code>DEPLOY</code> set to 1, due to a previous step in the CI pipeline:</p>
<pre style="background-color:#eff1f5;"><code class="language-bash"><span style="color:#a7adba;"># Builders starting with `dist-` are dist builders, but if they also end with
</span><span style="color:#a7adba;"># `-alt` they are alternate dist builders.
</span><span style="color:#b48ead;">if </span><span style="color:#96b5b4;">[[ </span><span style="color:#4f5b66;">&quot;$</span><span style="color:#a3be8c;">{</span><span style="color:#bf616a;">CI_JOB_NAME</span><span style="color:#a3be8c;">}</span><span style="color:#4f5b66;">&quot; = dist-* </span><span style="color:#96b5b4;">]]</span><span style="color:#4f5b66;">; </span><span style="color:#b48ead;">then
</span><span style="color:#4f5b66;">    </span><span style="color:#b48ead;">if </span><span style="color:#96b5b4;">[[ </span><span style="color:#4f5b66;">&quot;$</span><span style="color:#a3be8c;">{</span><span style="color:#bf616a;">CI_JOB_NAME</span><span style="color:#a3be8c;">}</span><span style="color:#4f5b66;">&quot; = *-alt </span><span style="color:#96b5b4;">]]</span><span style="color:#4f5b66;">; </span><span style="color:#b48ead;">then
</span><span style="color:#4f5b66;">        </span><span style="color:#96b5b4;">echo </span><span style="color:#4f5b66;">&quot;</span><span style="color:#a3be8c;">alternate dist builder detected, setting DEPLOY_ALT=1</span><span style="color:#4f5b66;">&quot;
</span><span style="color:#4f5b66;">        </span><span style="color:#8fa1b3;">ciCommandSetEnv</span><span style="color:#4f5b66;"> DEPLOY_ALT 1
</span><span style="color:#4f5b66;">    </span><span style="color:#b48ead;">else
</span><span style="color:#4f5b66;">        </span><span style="color:#96b5b4;">echo </span><span style="color:#4f5b66;">&quot;</span><span style="color:#a3be8c;">normal dist builder detected, setting DEPLOY=1</span><span style="color:#4f5b66;">&quot;
</span><span style="color:#4f5b66;">        </span><span style="color:#8fa1b3;">ciCommandSetEnv</span><span style="color:#4f5b66;"> DEPLOY 1
</span><span style="color:#4f5b66;">    </span><span style="color:#b48ead;">fi
</span><span style="color:#b48ead;">fi
</span></code></pre>
<p>In addition, the jobs launched by myself had <code>GITHUB_EVENT_NAME=pull_request</code>,
while the jobs launched by bors had <code>GITHUB_EVENT_NAME=push</code>.
Therefore in my case, the job <code>x86_64-gnu-llvm-14</code> didn't complain about <code>metrics.json</code> because
it skipped the uploading step due to its environment settings. That's why the default jobs didn't fail.</p>
<hr />
<p><a href="../index.html">Return...</a></p>
</div>
</body>
</html>
